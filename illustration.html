<!DOCTYPE html>
<html>
<head><title>Submit Illustration</title>
<script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
<link rel="stylesheet" type="text/css" href="drawperator.css" />
</head>
<body class="unselectable" unselectable="on">
<label>Name: <input id="username" maxlength="80" /></label>
<br/>
<canvas id="canvas" width="400px" height="400px" class="unselectable" unselectable="on"></canvas>
<br />
<input type="button" id="clear" value="Clear" /> <input type="button" id="submit" value="Submit" />
<script>
var c2d = document.getElementById("canvas").getContext("2d");
var paint = false;
var mouseX, mouseY;
$("#canvas").mousedown(function(e) {
   mouseX = e.pageX - this.offsetLeft;
   mouseY = e.pageY - this.offsetTop;
   paint = true;
});
$("#canvas").bind('touchstart', function(e) {
   e.preventDefault();
   e = e.originalEvent;   
   var touch = e.touches.item(0);
   mouseX = touch.pageX - this.offsetLeft;
   mouseY = touch.pageY - this.offsetTop;
   paint = true;
});
$("#canvas").mousemove(function(e) {
   if (paint) {
      var newX = e.pageX - this.offsetLeft;
      var newY = e.pageY - this.offsetTop;
      c2d.beginPath();
      c2d.moveTo(mouseX, mouseY);
      c2d.lineTo(newX, newY);
      c2d.closePath();
      c2d.stroke();
      mouseX = newX;
      mouseY = newY;
   }
});
$("#canvas").bind('touchmove', function(e) {
   if (paint) {
      e.preventDefault();
      e = e.originalEvent;
      var touch = e.touches.item(0);
      newX = touch.pageX - this.offsetLeft;
      newY = touch.pageY - this.offsetTop;      
      c2d.beginPath();
      c2d.moveTo(mouseX, mouseY);
      c2d.lineTo(newX, newY);
      c2d.closePath();
      c2d.stroke();
      mouseX = newX;
      mouseY = newY;
   }
});
$("#canvas").bind('mouseup touchend', function(e) { paint = false; });
$("#canvas").mouseleave(function(e) { paint = false; });
$("#submit").click(function(e) {
   $.ajax({type: "POST", url: "illustration.php",
      data:{'username':$("#username")[0].value,format:"PNG",
         'illustration':$("#canvas")[0].toDataURL('image/png').substring(22),
         'predecessor':predecessor}})
   .done(function(result) {
      $("#submit").prop("disabled", true);
      $("<p/>").append(
         $("<a/>").attr("href", "phrase.html?predecessor=" + result.id).text("Copy this link to the next player")
      ).insertAfter("#canvas");
   })
   .fail(function(jqXHR, textStatus) {
      $("<p/>").text(textStatus).insertAfter("#canvas");
   });   
});
$("#clear").click(function(e) {
   c2d.clearRect(0, 0, 400, 400);
});
var predecessor = null;
$(function() {
   var predecessorEx = new RegExp("[\\?&]predecessor=([^&#]*)").exec(location.search);
   if (predecessorEx != null) {
      predecessor = predecessorEx[1];
      $.ajax({type: "GET", url: "phrase/" + predecessor})
      .done(function(result) {
         $('body').prepend($('<p/>').text(result.phrase));
      })
      .fail(function(jqXHR, textStatus) {
         $('body').prepend($('<p/>').text("Failed to load phrase: " + textStatus));
      });
   }
});
</script>
</body>
</html>